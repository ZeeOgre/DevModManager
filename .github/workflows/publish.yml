name: CI Publish and Release

on:
  push:
    tags:
      - 'v*'             # create GitHub Release when tags like v1.2.3 are pushed
  workflow_dispatch: {}  # allow manual runs for testing

permissions:
  contents: write

env:
  BUILD_PROJECT: DMM.Standalone.DependencyChecker/DMM.Standalone.DependencyChecker.csproj
  RID: win-x64

jobs:
  publish:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Restore
        run: dotnet restore ${{ env.BUILD_PROJECT }}

      - name: Publish framework-dependent build (slim)
        run: |
          dotnet publish ${{ env.BUILD_PROJECT }} `
            -c Release `
            -r ${{ env.RID }} `
            --self-contained false `
            -p:PublishSingleFile=true `
            -p:PublishTrimmed=false `
            -p:DebugType=None `
            -p:IncludeSymbols=false `
            -p:OutputType=Exe `
            -p:AssemblyName=dmmdeps `
            -p:EnableLocalReleaseTrigger=false `
            -o ./out/dmmdeps

      - name: Publish self-contained single-file (fat) build
        run: |
          dotnet publish ${{ env.BUILD_PROJECT }} `
            -c Release `
            -r ${{ env.RID }} `
            --self-contained true `
            -p:PublishSingleFile=true `
            -p:PublishTrimmed=true `
            -p:DebugType=None `
            -p:IncludeSymbols=false `
            -p:OutputType=Exe `
            -p:EnableCompressionInSingleFile=true `
            -p:AssemblyName=dmmdeps_fat `
            -p:EnableLocalReleaseTrigger=false `
            -o ./out/dmmdeps-fat

      - name: Verify and prepare zips
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path out\zips -Force | Out-Null
          
          # Verify framework-dependent exe
          $slimExe = "out\dmmdeps\dmmdeps.exe"
          if (-not (Test-Path $slimExe)) { 
            Write-Error "Framework-dependent exe not found at $slimExe"
            Get-ChildItem -Path out\dmmdeps -Recurse
            exit 1 
          }
          Write-Host "✓ Found dmmdeps.exe ($(((Get-Item $slimExe).Length / 1MB).ToString('0.00')) MB)"
          
          # Verify self-contained exe
          $fatExe = "out\dmmdeps-fat\dmmdeps_fat.exe"
          if (-not (Test-Path $fatExe)) { 
            Write-Error "Self-contained exe not found at $fatExe"
            Get-ChildItem -Path out\dmmdeps-fat -Recurse
            exit 1 
          }
          Write-Host "✓ Found dmmdeps_fat.exe ($(((Get-Item $fatExe).Length / 1MB).ToString('0.00')) MB)"
          
          # Create zips with correct names
          Compress-Archive -Path $slimExe -DestinationPath out\zips\dmmdeps.zip -Force
          Compress-Archive -Path $fatExe -DestinationPath out\zips\dmmdeps-fat.zip -Force
          
          Write-Host "✓ Created release packages:"
          Get-ChildItem -Path out\zips | ForEach-Object {
            Write-Host "  - $($_.Name) ($(($_.Length / 1MB).ToString('0.00')) MB)"
          }

      - name: Upload workflow artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dmmdeps-executables
          path: |
            out/zips/dmmdeps.zip
            out/zips/dmmdeps-fat.zip

      - name: Ensure GitHub release exists (create if missing, bump tag with retries if already exists)
        id: ensure_release
        uses: actions/github-script@v6
        with:
          script: |
            const tag = context.ref.replace('refs/tags/','');
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const sha = context.sha;
            const maxAttempts = 3;

            async function createReleaseForTag(t) {
              const { data: newRel } = await github.rest.repos.createRelease({ 
                owner, 
                repo, 
                tag_name: t, 
                name: `DMM Dependency Checker ${t}`, 
                body: `## DevModManager Dependency Checker ${t}\n\n### Downloads\n- **dmmdeps.zip** - Framework-dependent (requires .NET 8 Runtime, ~2-5 MB)\n- **dmmdeps-fat.zip** - Self-contained (includes .NET 8 Runtime, ~70-90 MB)\n\n### Usage\n\`\`\`\ndmmdeps.exe <plugin-path> [options]\n\`\`\``, 
                draft: false, 
                prerelease: false 
              });
              core.info(`Created release id=${newRel.id} for ${t}`);
              return { upload_url: newRel.upload_url, id: newRel.id, tag: t };
            }

            try {
              const { data: release } = await github.rest.repos.getReleaseByTag({ owner, repo, tag });
              core.info(`Release for ${tag} already exists (id=${release.id}). Will attempt to bump tag and create a new release.`);

              const m = tag.match(/^v?(\d+)\.(\d+)\.(\d+)$/);
              if (!m) throw new Error(`Cannot parse tag '${tag}' as MAJOR.MINOR.PATCH`);
              const major = parseInt(m[1],10), minor = parseInt(m[2],10), basePatch = parseInt(m[3],10);

              for (let attempt = 1; attempt <= maxAttempts; attempt++) {
                const newPatch = basePatch + attempt;
                const newTag = `v${major}.${minor}.${newPatch}`;
                core.info(`Attempt ${attempt}/${maxAttempts}: creating tag ref ${newTag} -> ${sha}`);
                try {
                  await github.rest.git.createRef({ owner, repo, ref: `refs/tags/${newTag}`, sha });
                  core.info(`Created ref refs/tags/${newTag}`);
                  return await createReleaseForTag(newTag);
                } catch (err) {
                  core.warning(`Attempt ${attempt} failed: ${err.message}`);
                  if (err.status === 422 || (err.message && err.message.includes('already exists'))) {
                    core.info(`Tag ${newTag} already exists, will try next patch.`);
                  } else {
                    throw err;
                  }
                }
              }

              throw new Error(`Failed to create bumped tag after ${maxAttempts} attempts.`);
            } catch (err) {
              if (err.status === 404) {
                core.info(`No existing release for ${tag}. Creating new release.`);
                return await createReleaseForTag(tag);
              }
              throw err;
            }

      - name: Upload dmmdeps.zip to release
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ fromJson(steps.ensure_release.outputs.result).upload_url }}
          asset_path: out/zips/dmmdeps.zip
          asset_name: dmmdeps.zip
          asset_content_type: application/zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload dmmdeps-fat.zip to release
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ fromJson(steps.ensure_release.outputs.result).upload_url }}
          asset_path: out/zips/dmmdeps-fat.zip
          asset_name: dmmdeps-fat.zip
          asset_content_type: application/zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}