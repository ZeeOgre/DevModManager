name: CI Publish and Release

on:
  push:
    tags:
      - 'v*'             # create GitHub Release when tags like v1.2.3 are pushed
  workflow_dispatch: {}  # allow manual runs for testing

permissions:
  contents: write

env:
  BUILD_PROJECT: DMM.Standalone.DependencyChecker/DMM.Standalone.DependencyChecker.csproj
  RID: win-x64

jobs:
  publish:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Restore
        run: dotnet restore ${{ env.BUILD_PROJECT }}

      - name: Publish framework-dependent build
        run: |
          dotnet publish ${{ env.BUILD_PROJECT }} -c Release --self-contained false /p:PublishSingleFile=true /p:DebugType=None /p:IncludeSymbols=false /p:OutputType=Exe /p:AssemblyName=dmmdeps /p:EnableLocalReleaseTrigger=false -o ./out/dmmdeps

      - name: Publish self-contained single-file (fat) build
        run: |
          dotnet publish ${{ env.BUILD_PROJECT }} -c Release -r ${{ env.RID }} --self-contained true /p:PublishSingleFile=true /p:PublishTrimmed=true /p:DebugType=None /p:IncludeSymbols=false /p:OutputType=Exe /p:EnableCompressionInSingleFile=true /p:AssemblyName=dmmdeps_fat /p:EnableLocalReleaseTrigger=false -o ./out/dmmdeps-fat

      - name: Normalize names and prepare zips
        shell: pwsh
        run: |
          mkdir out\zips -ErrorAction SilentlyContinue
          
          # Framework-dependent build - already named dmmdeps.exe
          $d1 = Get-ChildItem -Path out\dmmdeps -Filter dmmdeps.exe -File | Select-Object -First 1
          if ($null -eq $d1) { 
            Write-Error "Framework-dependent dmmdeps.exe not found in out\dmmdeps"
            Get-ChildItem -Path out\dmmdeps
            exit 1 
          }
          
          # Self-contained build - needs renaming from dmmdeps_fat.exe to dmmdeps-fat.exe
          $d2 = Get-ChildItem -Path out\dmmdeps-fat -Filter dmmdeps_fat.exe -File | Select-Object -First 1
          if ($null -eq $d2) { 
            Write-Error "Self-contained dmmdeps_fat.exe not found in out\dmmdeps-fat"
            Get-ChildItem -Path out\dmmdeps-fat
            exit 1 
          }
          Copy-Item $d2.FullName out\dmmdeps-fat\dmmdeps-fat.exe -Force
          
          # Create zips
          Compress-Archive -Path $d1.FullName -DestinationPath out\zips\dmmdeps.zip -Force
          Compress-Archive -Path out\dmmdeps-fat\dmmdeps-fat.exe -DestinationPath out\zips\dmmdeps-fat.zip -Force
          
          # Verify zips
          Write-Host "Created zips:"
          Get-ChildItem out\zips
      - name: Upload workflow artifacts (optional)
        uses: actions/upload-artifact@v4
        with:
          name: dmmdeps-zips
          path: out/zips

      - name: Ensure GitHub release exists (create if missing, bump tag with retries if already exists)
        id: ensure_release
        uses: actions/github-script@v6
        with:
          script: |
            const tag = context.ref.replace('refs/tags/','');
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const sha = context.sha;
            const maxAttempts = 3;

            async function createReleaseForTag(t) {
              const releaseBody = `## DevModManager Dependency Checker ${t}

            ### What It Does
            Scans Starfield plugins (.esm/.esp) and discovers all asset dependencies:
            - Meshes, Materials, Textures (with PC & Xbox paths)
            - Scripts (Papyrus .psc/.pex with automatic import resolution)
            - Terrain (.btd files, overlay masks, and source TIF files)
            - Interface Icons (Inventory/ShipBuilder/Workshop + source TIF files)
            - Voice Assets (PC & Xbox, dev & runtime)
            - Particles, Animations, Morphs, and more

            **Outputs:**
            - \`.achlist\` - JSON array of PC file paths (for Achievement-safe mod managers)
            - \`_deps.csv\` - Detailed spreadsheet with file paths, asset types, and discovery sources

            ### Downloads
            - **dmmdeps.zip** (~186 KB) - Requires [.NET 8 Runtime](https://dotnet.microsoft.com/download/dotnet/8.0/runtime)
            - **dmmdeps-fat.zip** (~10 MB) - Includes .NET 8, no dependencies

            ### Basic Usage
            \`\`\`
            dmmdeps.exe "C:\\Path\\To\\YourMod.esm"
            \`\`\`
            Creates \`YourMod.achlist\` and \`YourMod_deps.csv\` in the same folder.

            ### Command-Line Options
            \`\`\`
            dmmdeps.exe <pluginPath> [options]

            Options:
              --gameroot <path>     Override game root (parent of Data folder)
              --xboxdata <path>     Override Xbox Data root (default from CreationKit.ini)
              --tifroot <path>      Override TIF source root (default ..\\..\\Source\\TGATextures)
              --scriptsroot <path>  Override Scripts folder (default Data\\Scripts)
              --test                Write .achlist.test instead of .achlist
              --quiet               Suppress skipped-file messages
              --silent              Suppress all output except start/completion
            \`\`\`

            ### Examples
            **Auto-detect everything:**
            \`\`\`
            dmmdeps.exe "C:\\Games\\Starfield\\Data\\MyMod.esm"
            \`\`\`

            **Custom development setup:**
            \`\`\`
            dmmdeps.exe "G:\\ModDev\\MyMod.esm" --gameroot "C:\\Games\\Starfield" --tifroot "G:\\Source\\TGATextures"
            \`\`\`

            **CI/CD pipeline (silent mode):**
            \`\`\`
            dmmdeps.exe MyMod.esm --silent
            \`\`\`

            ### Performance
            Sub-second execution for ~5000 files. No directory walking - deterministic asset discovery based on plugin content.

            ### Full Documentation
            See [README.md](https://github.com/ZeeOgre/DevModManager/blob/master/DMM.Standalone.DependencyChecker/README.md) for detailed documentation, troubleshooting, and integration guide.`;

              const { data: newRel } = await github.rest.repos.createRelease({ 
                owner, 
                repo, 
                tag_name: t, 
                name: `dmmdeps ${t}`, 
                body: releaseBody, 
                draft: false, 
                prerelease: false 
              });
              core.info(`Created release id=${newRel.id} for ${t}`);
              return { upload_url: newRel.upload_url, id: newRel.id, tag: t };
            }

            try {
              const { data: release } = await github.rest.repos.getReleaseByTag({ owner, repo, tag });
              core.info(`Release for ${tag} already exists (id=${release.id}). Will attempt to bump tag and create a new release.`);

              const m = tag.match(/^v?(\d+)\.(\d+)\.(\d+)$/);
              if (!m) throw new Error(`Cannot parse tag '${tag}' as MAJOR.MINOR.PATCH`);
              const major = parseInt(m[1],10), minor = parseInt(m[2],10), basePatch = parseInt(m[3],10);

              for (let attempt = 1; attempt <= maxAttempts; attempt++) {
                const newPatch = basePatch + attempt;
                const newTag = `v${major}.${minor}.${newPatch}`;
                core.info(`Attempt ${attempt}/${maxAttempts}: creating tag ref ${newTag} -> ${sha}`);
                try {
                  await github.rest.git.createRef({ owner, repo, ref: `refs/tags/${newTag}`, sha });
                  core.info(`Created ref refs/tags/${newTag}`);
                  return await createReleaseForTag(newTag);
                } catch (err) {
                  core.warning(`Attempt ${attempt} failed: ${err.message}`);
                  if (err.status === 422 || (err.message && err.message.includes('already exists'))) {
                    core.info(`Tag ${newTag} already exists, will try next patch.`);
                  } else {
                    throw err;
                  }
                }
              }

              throw new Error(`Failed to create bumped tag after ${maxAttempts} attempts.`);
            } catch (err) {
              if (err.status === 404) {
                core.info(`No existing release for ${tag}. Creating new release.`);
                return await createReleaseForTag(tag);
              }
              throw err;
            }

      - name: Upload dmmdeps.zip to release
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ fromJson(steps.ensure_release.outputs.result).upload_url }}
          asset_path: out/zips/dmmdeps.zip
          asset_name: dmmdeps.zip
          asset_content_type: application/zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload dmmdeps-fat.zip to release
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ fromJson(steps.ensure_release.outputs.result).upload_url }}
          asset_path: out/zips/dmmdeps-fat.zip
          asset_name: dmmdeps-fat.zip
          asset_content_type: application/zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Inspect slim exe size
        shell: pwsh
        run: |
          $exe = "out\dmmdeps\dmmdeps.exe"
          if (-not (Test-Path $exe)) { throw "Missing $exe" }
          $len = (Get-Item $exe).Length
          Write-Host "Slim dmmdeps.exe bytes: $len"
          Write-Host "Slim dmmdeps.exe MB: $([Math]::Round($len / 1MB, 2))"