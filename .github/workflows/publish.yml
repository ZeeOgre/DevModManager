name: CI Publish and Release

on:
  push:
    tags:
      - 'v*'             # create GitHub Release when tags like v1.2.3 are pushed
  workflow_dispatch: {}  # allow manual runs for testing

permissions:
  contents: write

env:
  BUILD_PROJECT: DMM.Standalone.DependencyChecker/DMM.Standalone.DependencyChecker.csproj
  RID: win-x64

jobs:
  publish:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Restore
        run: dotnet restore ${{ env.BUILD_PROJECT }}

      - name: Publish framework-dependent build
        run: |
          dotnet publish ${{ env.BUILD_PROJECT }} -c Release -r ${{ env.RID }} --self-contained false /p:PublishSingleFile=false /p:EnableLocalReleaseTrigger=false -o ./out/dmmdeps

      - name: Publish self-contained single-file (fat) build
        run: |
          dotnet publish ${{ env.BUILD_PROJECT }} -c Release -r ${{ env.RID }} --self-contained true /p:PublishSingleFile=true /p:PublishTrimmed=false /p:EnableLocalReleaseTrigger=false -o ./out/dmmdeps-fat

      - name: Normalize names and prepare zips
        shell: pwsh
        run: |
          mkdir out\zips
          $d1 = Get-ChildItem -Path out\dmmdeps -Filter *.exe -File | Select-Object -First 1
          if ($null -eq $d1) { Write-Error "framework-dependent exe not found"; exit 1 }
          Copy-Item $d1.FullName out\dmmdeps\dmmdeps.exe -Force
          $d2 = Get-ChildItem -Path out\dmmdeps-fat -Filter *.exe -File | Select-Object -First 1
          if ($null -eq $d2) { Write-Error "fat exe not found"; exit 1 }
          Copy-Item $d2.FullName out\dmmdeps-fat\dmmdeps-fat.exe -Force
          Compress-Archive -Path out\dmmdeps\dmmdeps.exe -DestinationPath out\zips\dmmdeps.zip -Force
          Compress-Archive -Path out\dmmdeps-fat\dmmdeps-fat.exe -DestinationPath out\zips\dmmdeps-fat.zip -Force

      - name: Upload workflow artifacts (optional)
        uses: actions/upload-artifact@v4
        with:
          name: dmmdeps-zips
          path: out/zips

      - name: Create GitHub release
        if: startsWith(github.ref, 'refs/tags/')
        id: create_release
        uses: actions/create-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          release_name: ${{ github.ref_name }}
          body: 'Automated release for ${{ github.ref_name }}'
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload dmmdeps.zip to release
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: out/zips/dmmdeps.zip
          asset_name: dmmdeps.zip
          asset_content_type: application/zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload dmmdeps-fat.zip to release
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: out/zips/dmmdeps-fat.zip
          asset_name: dmmdeps-fat.zip
          asset_content_type: application/zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}